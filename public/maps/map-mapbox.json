{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "map-mapbox",
  "title": "Map (React Native) [Mapbox]",
  "description": "A Mapbox-powered map component for React Native with markers, popups, labels, routes, and controls. Using maptiler for cheaper commercial use.",
  "dependencies": [
    "@rnmapbox/maps@^10.2.10",
    "expo-location@^19.0.8"
  ],
  "registryDependencies": [],
  "files": [
    {
      "path": "src/registry/map-mapbox.txt",
      "content": "import { useTheme } from \"@/lib/theme-context\";\nimport { cn } from \"@/lib/utils\";\nimport Mapbox, {\n  type Camera as MapboxCameraRef,\n  type MapView as MapboxMapViewRef,\n} from \"@rnmapbox/maps\";\nimport * as Location from \"expo-location\";\nimport {\n  createContext,\n  useContext,\n  useEffect,\n  useId,\n  useMemo,\n  useRef,\n  useState,\n  type ReactNode,\n} from \"react\";\nimport { ActivityIndicator, Pressable, Text, View } from \"react-native\";\n\n// Initialize Mapbox\nconst MAPBOX_ACCESS_TOKEN = process.env.EXPO_PUBLIC_MAPBOX_API_KEY;\n\nif (MAPBOX_ACCESS_TOKEN) {\n  Mapbox.setAccessToken(MAPBOX_ACCESS_TOKEN);\n} else {\n  console.warn(\n    \"[map-mapbox] EXPO_PUBLIC_MAPBOX_API_KEY not found. \" +\n      \"Get your free Mapbox token at: https://account.mapbox.com/access-tokens/\"\n  );\n}\n\n// Camera wrapper to provide MapLibre-compatible API\ntype CameraAPI = {\n  flyTo: (params: {\n    center: [number, number];\n    zoom: number;\n    duration: number;\n  }) => void;\n  easeTo: (params: {\n    center: [number, number];\n    zoom: number;\n    duration: number;\n  }) => void;\n};\n\ntype CameraWrapperRef = {\n  current: CameraAPI | null;\n};\n\nfunction createCameraWrapper(\n  internalCameraRef: React.RefObject<MapboxCameraRef | null>\n): CameraWrapperRef {\n  return {\n    current: {\n      flyTo: ({ center, zoom, duration }) => {\n        internalCameraRef.current?.setCamera({\n          centerCoordinate: center,\n          zoomLevel: zoom,\n          animationDuration: duration,\n          animationMode: \"flyTo\",\n        });\n      },\n      easeTo: ({ center, zoom, duration }) => {\n        internalCameraRef.current?.setCamera({\n          centerCoordinate: center,\n          zoomLevel: zoom,\n          animationDuration: duration,\n          animationMode: \"easeTo\",\n        });\n      },\n    },\n  };\n}\n\ntype MapContextValue = {\n  mapRef: React.RefObject<MapboxMapViewRef | null>;\n  cameraRef: CameraWrapperRef;\n  isLoaded: boolean;\n  theme: \"light\" | \"dark\";\n};\n\nconst MapContext = createContext<MapContextValue | null>(null);\n\nfunction useMap() {\n  const context = useContext(MapContext);\n  if (!context) {\n    throw new Error(\"useMap must be used within a Map component\");\n  }\n  return context;\n}\n\nconst defaultStyles = {\n  dark: Mapbox.StyleURL.Dark,\n  light: Mapbox.StyleURL.Street,\n};\n\ntype MapStyleOption = string | object;\n\ntype MapProps = {\n  children?: ReactNode;\n  /** Custom map styles for light and dark themes. Overrides the default Mapbox styles. */\n  styles?: {\n    light?: MapStyleOption;\n    dark?: MapStyleOption;\n  };\n  /** Initial center coordinate [longitude, latitude] */\n  center?: [number, number];\n  /** Initial zoom level */\n  zoom?: number;\n  /** Container style */\n  className?: string;\n  /** Show loading indicator */\n  showLoader?: boolean;\n};\n\nconst DefaultLoader = () => (\n  <View className=\"absolute inset-0 justify-center items-center bg-white/80\">\n    <ActivityIndicator size=\"small\" color=\"#999\" />\n  </View>\n);\n\nfunction Map({\n  children,\n  styles,\n  center = [0, 0],\n  zoom = 10,\n  className,\n  showLoader = true,\n}: MapProps) {\n  const mapRef = useRef<MapboxMapViewRef | null>(null);\n  const internalCameraRef = useRef<MapboxCameraRef | null>(null);\n  const [isLoaded, setIsLoaded] = useState(false);\n  const { colorScheme } = useTheme();\n  const theme = colorScheme === \"dark\" ? \"dark\" : \"light\";\n\n  // Create camera wrapper with MapLibre-compatible API\n  const cameraRef = useMemo(\n    () => createCameraWrapper(internalCameraRef),\n    []\n  );\n\n  const mapStyle =\n    theme === \"dark\"\n      ? styles?.dark ?? defaultStyles.dark\n      : styles?.light ?? defaultStyles.light;\n\n  const handleMapIdle = () => {\n    if (!isLoaded) {\n      setIsLoaded(true);\n    }\n  };\n\n  return (\n    <MapContext.Provider value={{ mapRef, cameraRef, isLoaded, theme }}>\n      <View className={cn(\"flex-1 relative\", className)}>\n        <Mapbox.MapView\n          ref={mapRef}\n          style={{ flex: 1 }}\n          styleURL={mapStyle as string}\n          onDidFinishLoadingMap={handleMapIdle}\n          compassEnabled={false}\n          logoEnabled={false}\n          attributionEnabled={false}\n        >\n          <Mapbox.Camera\n            ref={internalCameraRef}\n            zoomLevel={zoom}\n            centerCoordinate={center}\n            animationMode=\"flyTo\"\n            animationDuration={1000}\n          />\n          {children}\n        </Mapbox.MapView>\n        {showLoader && !isLoaded && <DefaultLoader />}\n      </View>\n    </MapContext.Provider>\n  );\n}\n\ntype MarkerContextValue = {\n  coordinate: [number, number];\n};\n\nconst MarkerContext = createContext<MarkerContextValue | null>(null);\n\ntype MapMarkerProps = {\n  children?: ReactNode;\n  label?: string;\n  /** Anchor point for the marker (0.0 to 1.0). Default is center (0.5, 0.5) */\n  anchor?: { x: number; y: number };\n  /** Allow marker to overlap with other markers */\n  allowOverlap?: boolean;\n  /** Callback when marker is pressed */\n  onPress?: () => void;\n} & (\n  | { coordinate: [number, number]; longitude?: never; latitude?: never }\n  | { longitude: number; latitude: number; coordinate?: never }\n);\n\nfunction MapMarker({\n  children,\n  label,\n  anchor = { x: 0.5, y: 0.5 },\n  allowOverlap = false,\n  onPress,\n  ...positionProps\n}: MapMarkerProps) {\n  const id = useId();\n\n  const coordinate: [number, number] =\n    \"coordinate\" in positionProps && positionProps.coordinate\n      ? positionProps.coordinate\n      : [positionProps.longitude, positionProps.latitude];\n\n  return (\n    <MarkerContext.Provider value={{ coordinate }}>\n      <Mapbox.MarkerView\n        id={id}\n        coordinate={coordinate}\n        anchor={anchor}\n        allowOverlap={allowOverlap}\n      >\n        <Pressable onPress={onPress}>\n          <View className=\"flex flex-row items-center justify-center\">\n            {children || <DefaultMarkerIcon />}\n            {label && <MarkerLabel>{label}</MarkerLabel>}\n          </View>\n        </Pressable>\n      </Mapbox.MarkerView>\n    </MarkerContext.Provider>\n  );\n}\n\ntype MarkerContentProps = {\n  children?: ReactNode;\n  className?: string;\n};\n\nfunction MarkerContent({ children, className }: MarkerContentProps) {\n  return (\n    <View className={cn(\"items-center justify-center\", className)}>\n      {children || <DefaultMarkerIcon />}\n    </View>\n  );\n}\n\nfunction DefaultMarkerIcon() {\n  return (\n    <View\n      className=\"w-4 h-4 rounded-full bg-blue-500 border-2 border-white shadow-md\"\n      style={{ elevation: 5 }}\n    />\n  );\n}\n\ntype MarkerPopupProps = {\n  children: ReactNode;\n  className?: string;\n  /** Title text for the callout */\n  title?: string;\n};\n\nfunction MarkerPopup({ children, className, title }: MarkerPopupProps) {\n  return (\n    <Mapbox.Callout title={title ?? \"\"} className={className}>\n      <View className=\"p-3 min-w-[100px] max-w-[300px]\">{children}</View>\n    </Mapbox.Callout>\n  );\n}\n\ntype MarkerLabelProps = {\n  children: ReactNode;\n  className?: string;\n  classNameText?: string;\n  position?: \"top\" | \"bottom\";\n};\n\nfunction MarkerLabel({\n  children,\n  className,\n  classNameText,\n  position = \"top\",\n}: MarkerLabelProps) {\n  return (\n    <View\n      className={cn(\n        \"absolute left-1/2 translate-x-[-50%]\",\n        position === \"top\" ? \"mb-1 bottom-full\" : \"mt-1 top-full\",\n        className\n      )}\n    >\n      <Text\n        className={cn(\n          \"text-[10px] font-semibold text-foreground\",\n          classNameText\n        )}\n      >\n        {children}\n      </Text>\n    </View>\n  );\n}\n\ntype MapControlsProps = {\n  position?: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\";\n  showZoom?: boolean;\n  showLocate?: boolean;\n  className?: string;\n  onLocate?: (coords: { longitude: number; latitude: number }) => void;\n};\n\nfunction MapControls({\n  position = \"bottom-right\",\n  showZoom = true,\n  showLocate = false,\n  className,\n  onLocate,\n}: MapControlsProps) {\n  const { cameraRef, mapRef, isLoaded } = useMap();\n  const [waitingForLocation, setWaitingForLocation] = useState(false);\n  const [currentZoom, setCurrentZoom] = useState(10);\n\n  const handleZoomIn = async () => {\n    if (cameraRef.current && mapRef.current) {\n      const center = await mapRef.current.getCenter();\n      const newZoom = Math.min(currentZoom + 1, 20);\n      setCurrentZoom(newZoom);\n      cameraRef.current.easeTo({\n        center: center as [number, number],\n        zoom: newZoom,\n        duration: 300,\n      });\n    }\n  };\n\n  const handleZoomOut = async () => {\n    if (cameraRef.current && mapRef.current) {\n      const center = await mapRef.current.getCenter();\n      const newZoom = Math.max(currentZoom - 1, 0);\n      setCurrentZoom(newZoom);\n      cameraRef.current.easeTo({\n        center: center as [number, number],\n        zoom: newZoom,\n        duration: 300,\n      });\n    }\n  };\n\n  const handleLocate = async () => {\n    setWaitingForLocation(true);\n    try {\n      const location = await Location.getCurrentPositionAsync({});\n      const coords = {\n        longitude: location.coords.longitude,\n        latitude: location.coords.latitude,\n      };\n\n      if (cameraRef.current) {\n        cameraRef.current.flyTo({\n          center: [coords.longitude, coords.latitude],\n          zoom: 14,\n          duration: 1500,\n        });\n      }\n\n      if (onLocate) {\n        onLocate(coords);\n      }\n    } catch (error) {\n      console.error(\"Error getting location:\", error);\n    } finally {\n      setWaitingForLocation(false);\n    }\n  };\n\n  if (!isLoaded) return null;\n\n  const positionStyle = {\n    \"top-left\": { top: 8, left: 8 },\n    \"top-right\": { top: 8, right: 8 },\n    \"bottom-left\": { bottom: 8, left: 8 },\n    \"bottom-right\": { bottom: 8, right: 8 },\n  }[position];\n\n  return (\n    <View className={cn(\"absolute gap-1.5\", className)} style={positionStyle}>\n      {showZoom && (\n        <View\n          className=\"rounded border border-gray-200 bg-white shadow-sm overflow-hidden\"\n          style={{ elevation: 2 }}\n        >\n          <ControlButton onPress={handleZoomIn} label=\"+\">\n            <Text className=\"text-lg font-semibold text-gray-700\">+</Text>\n          </ControlButton>\n          <View className=\"h-[1px] bg-gray-200\" />\n          <ControlButton onPress={handleZoomOut} label=\"-\">\n            <Text className=\"text-lg font-semibold text-gray-700\">‚àí</Text>\n          </ControlButton>\n        </View>\n      )}\n      {showLocate && (\n        <View\n          className=\"rounded border border-gray-200 bg-white shadow-sm overflow-hidden\"\n          style={{ elevation: 2 }}\n        >\n          <ControlButton\n            onPress={handleLocate}\n            label=\"üìç\"\n            disabled={waitingForLocation}\n          >\n            {waitingForLocation ? (\n              <ActivityIndicator size=\"small\" color=\"#666\" />\n            ) : (\n              <Text className=\"text-lg font-semibold text-gray-700\">üìç</Text>\n            )}\n          </ControlButton>\n        </View>\n      )}\n    </View>\n  );\n}\n\nfunction ControlButton({\n  onPress,\n  label,\n  children,\n  disabled = false,\n}: {\n  onPress: () => void;\n  label: string;\n  children: React.ReactNode;\n  disabled?: boolean;\n}) {\n  return (\n    <Pressable\n      onPress={onPress}\n      disabled={disabled}\n      className=\"w-8 h-8 justify-center items-center active:bg-gray-100\"\n      style={disabled ? { opacity: 0.5 } : undefined}\n      accessibilityLabel={label}\n      accessibilityRole=\"button\"\n    >\n      {children}\n    </Pressable>\n  );\n}\n\ntype MapRouteProps = {\n  coordinates: Array<[number, number]>;\n  color?: string;\n  width?: number;\n  opacity?: number;\n  dashArray?: [number, number];\n};\n\nfunction MapRoute({\n  coordinates,\n  color = \"#4285F4\",\n  width = 3,\n  opacity = 0.8,\n  dashArray,\n}: MapRouteProps) {\n  const id = useId();\n  const sourceId = `route-source-${id}`;\n  const layerId = `route-layer-${id}`;\n\n  if (coordinates.length < 2) {\n    return null;\n  }\n\n  const shape = {\n    type: \"Feature\" as const,\n    properties: {},\n    geometry: {\n      type: \"LineString\" as const,\n      coordinates,\n    },\n  };\n\n  return (\n    <Mapbox.ShapeSource id={sourceId} shape={shape}>\n      <Mapbox.LineLayer\n        id={layerId}\n        style={{\n          lineColor: color,\n          lineWidth: width,\n          lineOpacity: opacity,\n          ...(dashArray && { lineDasharray: dashArray }),\n          lineJoin: \"round\",\n          lineCap: \"round\",\n        }}\n      />\n    </Mapbox.ShapeSource>\n  );\n}\n\ntype MapUserLocationProps = {\n  /** Show user location on the map */\n  visible?: boolean;\n  /** Show accuracy circle around user location */\n  showAccuracy?: boolean;\n  /** Show heading arrow indicating device direction */\n  showHeading?: boolean;\n  /** Whether the location marker is animated between updates */\n  animated?: boolean;\n  /** Minimum delta in meters for location updates */\n  minDisplacement?: number;\n  /** Callback when user location is pressed */\n  onPress?: () => void;\n  /** Auto-request location permissions if not granted */\n  autoRequestPermission?: boolean;\n};\n\nfunction MapUserLocation({\n  visible = true,\n  showAccuracy = true,\n  showHeading = false,\n  animated = true,\n  minDisplacement,\n  onPress,\n  autoRequestPermission = true,\n}: MapUserLocationProps) {\n  const [hasPermission, setHasPermission] = useState(false);\n  const [permissionChecked, setPermissionChecked] = useState(false);\n\n  useEffect(() => {\n    let mounted = true;\n\n    const checkAndRequestPermissions = async () => {\n      try {\n        if (autoRequestPermission) {\n          const { status } = await Location.requestForegroundPermissionsAsync();\n          if (mounted) {\n            setHasPermission(status === \"granted\");\n            setPermissionChecked(true);\n          }\n        } else {\n          if (mounted) {\n            setPermissionChecked(true);\n          }\n        }\n      } catch (error) {\n        console.error(\"Error requesting location permissions:\", error);\n        if (mounted) {\n          setHasPermission(false);\n          setPermissionChecked(true);\n        }\n      }\n    };\n\n    if (visible) {\n      checkAndRequestPermissions();\n    }\n\n    return () => {\n      mounted = false;\n    };\n  }, [visible, autoRequestPermission]);\n\n  if (!visible || !permissionChecked || !hasPermission) {\n    return null;\n  }\n\n  return (\n    <Mapbox.LocationPuck\n      puckBearingEnabled={showHeading}\n      pulsing={{ isEnabled: animated }}\n    />\n  );\n}\n\nexport {\n  Map,\n  MapControls,\n  MapMarker,\n  MapRoute,\n  MapUserLocation,\n  MarkerContent,\n  MarkerLabel,\n  MarkerPopup,\n  useMap\n};\n",
      "type": "registry:ui",
      "target": "components/ui/map.tsx"
    }
  ],
  "type": "registry:ui"
}